name: GFortran CI

on:
  push:
    branches: [ master ]
  pull_request:

env:
  # -Z : Fail CI if Codecov upload encounters issues
  # -v : verbose output
  # -X : disable unneeded functionality
  # -U : Curl params to avoid timeout issues
  CODECOV_OPTIONS: '-Z -X coveragepy -X xcode -U "--retry 5 --connect-timeout 5"' #-v 

jobs:


  basic_build:
    runs-on: ubuntu-18.04
    strategy:
      fail-fast: false
      matrix:
         gcc_v: [7, 8, 9]
    env:
      FC: gfortran
      FFLAGS: -O0 -fopenmp -Wall --coverage -ffpe-trap=invalid,zero,overflow,denormal
      GCC_V: ${{ matrix.gcc_v}}

    steps:
    - uses: actions/checkout@v2
    - name: Set GFortran version
      run: |
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-${GCC_V} 100 \
        --slave /usr/bin/gfortran gfortran /usr/bin/gfortran-${GCC_V} \
        --slave /usr/bin/gcov gcov /usr/bin/gcov-${GCC_V}

    # pFUnit library is used to build and run unit tests
    - name: pFUnit build Cache
      id: pfunit-cache
      uses: actions/cache@v2
      with:
        path: ~/pfunit/build/installed
        # To force a pFUnit rebuild (bust the cache), make a change to install_pfunit.sh
        key: ${{ runner.os }}-pfunit-gfortran${{ env.GCC_V }}-${{ hashFiles('dev_scripts/install_pfunit.sh') }}

    # TODO: We should specify a specific commit in install_pfunit.sh
    # so that we're not dependent on changes in pFUnit
    - name: Download and build pFUnit
      if: steps.pfunit-cache.outputs.cache-hit != 'true'
      run: ./dev_scripts/install_pfunit.sh ${HOME}/pfunit

    - name: Build ABIN
      run: ./configure --pfunit ${HOME}/pfunit/build/installed/ && make

    - name: Run Unit tests
      run: make unittest

    - name: Run End-to-End tests
      run: make e2etest

   # TODO: Separate unit test coverage
    - name: Upload code coverage to Codecov
      run:  bash <(curl -s https://codecov.io/bash) $CODECOV_OPTIONS


  optimized_build:
    runs-on: ubuntu-18.04
    needs: basic_build
    strategy:
      matrix:
         gcc_v: [7, 8, 9]
    env:
      FC: gfortran
      FFLAGS: -O3 -fopenmp -Wall
      GCC_V: ${{ matrix.gcc_v}}

    steps:
    - uses: actions/checkout@v2
    - name: Set GFortran version
      run: |
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-${GCC_V} 100 \
        --slave /usr/bin/gfortran gfortran /usr/bin/gfortran-${GCC_V}

    - name: pFUnit build Cache
      id: pfunit-cache
      uses: actions/cache@v2
      with:
        path: ~/pfunit/build/installed
        key: ${{ runner.os }}-pfunit-gfortran${{ env.GCC_V }}-${{ hashFiles('dev_scripts/install_pfunit.sh') }}

    - name: Download and build pFUnit
      if: steps.pfunit-cache.outputs.cache-hit != 'true'
      run: ./dev_scripts/install_pfunit.sh ${HOME}/pfunit

    - name: build ABIN
      run: ./configure --pfunit ${HOME}/pfunit/build/installed/ && make

    - name: Run Unit tests
      run: make unittest

    - name: Run End-to-End tests
      run: make e2etest

  # Consider whether this needs to be a separate job
  # or whether it should be default for all builds
  # Here we just take the defaults everywhere, except turning on FFTW
  # TODO: We actually need to build our own FFTW for different
  # GFortran versions
  fftw_build:
    # NOTE: I tried using `ubuntu-20.04` instead of `ubuntu-latest` which still points to Ubuntu 18.
    # https://github.com/actions/virtual-environments#available-environments
    # However, some tests started to fail, with small numerical differences ~1E-15.
    # Not sure why, since default gfortran on 20.04 is 9.3.0, i.e. the same as we already
    # test above. I tested this with both -O0 and -O2. 
    # When Github upgrades it's ubuntu-latest image we might run into problems.
    # We should regenerate our all our tests with GFortran 7 on Neon before that happens.
    runs-on: ubuntu-18.04
    needs: basic_build
    strategy:
      fail-fast: false
      matrix:
         gcc_v: [7]
    env:
      FFLAGS: -O0 -fopenmp -Wall --coverage -ffpe-trap=invalid,zero,overflow,denormal
      GCC_V: ${{ matrix.gcc_v}}
    steps:
    - uses: actions/checkout@v2

    - name: Install FFTW libraries
      run: sudo apt-get install libfftw3-dev

    - name: pFUnit build Cache
      id: pfunit-cache
      uses: actions/cache@v2
      with:
        path: ~/pfunit/build/installed
        key: ${{ runner.os }}-pfunit-gfortran${{ env.GCC_V }}-${{ hashFiles('dev_scripts/install_pfunit.sh') }}

    - name: Download and build pFUnit
      if: steps.pfunit-cache.outputs.cache-hit != 'true'
      run: ./dev_scripts/install_pfunit.sh ${HOME}/pfunit

    - name: Build ABIN
      run: ./configure --pfunit ${HOME}/pfunit/build/installed/ --fftw && make

    - name: Run Unit tests
      run: make unittest

    - name: Run End-to-End tests
      run: make e2etest

    - name: Codecov upload
      run:  bash <(curl -s https://codecov.io/bash) $CODECOV_OPTIONS

  mpich_build:
    runs-on: ubuntu-18.04
    needs: basic_build
    strategy:
      fail-fast: false
      matrix:
         gcc_v: [7, 8, 9]
         mpich_v: ["3.1.3", "3.3.2"]
    env:
      ABIN_FFLAGS: -O2 --coverage -fopenmp -ffpe-trap=invalid,zero,overflow,denormal
      # To speed-up MPICH build
      CFLAGS: -O0
      GCC_V: ${{ matrix.gcc_v}}
      MPICH_V: ${{matrix.mpich_v}}

    steps:
    - uses: actions/checkout@v2
    - name: Set GFortran version
      run: |
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-${GCC_V} 100 \
        --slave /usr/bin/gfortran gfortran /usr/bin/gfortran-${GCC_V} \
        --slave /usr/bin/gcov gcov /usr/bin/gcov-${GCC_V}
    - name: MPICH build Cache
      id: mpich-cache
      uses: actions/cache@v2
      with:
        path: ~/mpich/${{ env.MPICH_V }}/install
        key: ${{runner.os}}-mpich${{ env.MPICH_V }}-gfortran${{ env.GCC_V }}-${{hashFiles('dev_scripts/install_mpich.sh')}}

    - name: Build and Install MPICH
      if: steps.mpich-cache.outputs.cache-hit != 'true'
      run: ./dev_scripts/install_mpich.sh ${HOME}/mpich ${MPICH_V}

    - name: build ABIN
      run: |
            export FFLAGS=${ABIN_FFLAGS} &&\
            ./configure --mpi ${HOME}/mpich/${MPICH_V}/install &&\
            make
    - name: test ABIN
      run: make test
      # We upload to Codecov from the OpenMPI build,
      # so no need to do that here.
    - name: Codecov upload
      run:  bash <(curl -s https://codecov.io/bash) $CODECOV_OPTIONS

  openmpi_build:
    runs-on: ubuntu-18.04
    needs: basic_build
    strategy:
      fail-fast: false
      # Let's just test one GFortran version, we do not really
      # use OpenMPI with ABIN, and we already test all GCC
      # versions with MPICH.
      matrix:
         gcc_v: [7]
    env:
      ABIN_FFLAGS: -O0 --coverage -fopenmp -ffpe-trap=invalid,zero,overflow,denormal
      # To speed-up OpenMPI build
      CFLAGS: -O0
      GCC_V: ${{ matrix.gcc_v}}
      OPENMPI_V: "4.0"
      OPENMPI_PATCH: "0"

    steps:
    - uses: actions/checkout@v2
    - name: Set GFortran version
      run: |
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-${GCC_V} 100 \
        --slave /usr/bin/gfortran gfortran /usr/bin/gfortran-${GCC_V}
    - name: OpenMPI build cache
      id: openmpi-cache
      uses: actions/cache@v2
      with:
        path: ~/openmpi/${{ env.OPENMPI_V }}/install
        key: ${{runner.os}}-openmpi${{ env.OPENMPI_V }}-gfortran${{ env.GCC_V }}-${{hashFiles('dev_scripts/install_openmpi.sh')}}

    - name: Build and Install OpenMPI
      if: steps.openmpi-cache.outputs.cache-hit != 'true'
      run: ./dev_scripts/install_openmpi.sh ${HOME}/openmpi ${OPENMPI_V} ${OPENMPI_PATCH}

    - name: build ABIN
      run: |
        export FFLAGS=${ABIN_FFLAGS} &&\
        ./configure --mpi "${HOME}/openmpi/${OPENMPI_V}/install" &&\
        make
    - name: test ABIN
      run: make test
    - name: Codecov upload
      run:  bash <(curl -s https://codecov.io/bash) $CODECOV_OPTIONS


  plumed_build:
    runs-on: ubuntu-18.04
    needs: basic_build
    strategy:
      fail-fast: false
      matrix:
         plumed_v: [2.5.3, 2.6.2, 2.7.0]
         gcc_v: [7]

    env:
      PLUMED_V: ${{ matrix.plumed_v}}
      GCC_V: ${{ matrix.gcc_v}}
      ABIN_FFLAGS: -O0 -fopenmp --coverage -ffpe-trap=invalid,zero,overflow,denormal
      # Speeding up the Plumed build
      CFLAGS: -O0
      CXXLAGS: -O0

    steps:
    - uses: actions/checkout@v2
    - name: Plumed build cache
      id: plumed-cache
      uses: actions/cache@v2
      with:
        path: ~/plumed/${{ env.PLUMED_V }}/install
        key: ${{runner.os}}-plumed${{env.PLUMED_V}}-gcc${{ env.GCC_V }}-${{hashFiles('dev_scripts/install_plumed.sh')}}

    - name: Build and Install PLUMED
      if: steps.plumed-cache.outputs.cache-hit != 'true'
      run: ./dev_scripts/install_plumed.sh ${HOME}/plumed ${PLUMED_V}

    - name: pFUnit build Cache
      id: pfunit-cache
      uses: actions/cache@v2
      with:
        path: ~/pfunit/build/installed
        key: ${{ runner.os }}-pfunit-gfortran${{ env.GCC_V }}-${{ hashFiles('dev_scripts/install_pfunit.sh') }}

    - name: Download and build pFUnit
      if: steps.pfunit-cache.outputs.cache-hit != 'true'
      run: ./dev_scripts/install_pfunit.sh ${HOME}/pfunit

    - name: build ABIN
      run: |
        export FFLAGS=${ABIN_FFLAGS} &&\
        ./configure --plumed "${HOME}/plumed/${PLUMED_V}/install"\
                    --pfunit ~/pfunit/build/installed/ &&\
        make

    - name: Run Unit tests
      run: make unittest

    - name: Run End-to-End tests
      run: make e2etest

    - name: Codecov upload
      run:  bash <(curl -s https://codecov.io/bash) $CODECOV_OPTIONS
